#!/bin/bash -x

# Si pacman o yay se están ejecutando el script se detiene
(pgrep yay >/dev/null || pgrep pacman >/dev/null) && exit 1

KERNELS=()

# Comprobamos solo para los kernels que están instalados
if pacman -Q linux-lts >/dev/null 2>&1; then
	KERNELS+=("lts")
else
	rm -f /etc/mkinitcpio.d/linux-lts.preset
fi

if pacman -Q linux-zen >/dev/null 2>&1; then
	KERNELS+=("zen")
else
	rm -f /etc/mkinitcpio.d/linux-zen.preset
fi

# Si solo esta instalado el kernel predeterminado detenemos la ejecución
[ ${#KERNELS[@]} -eq 0 ] && exit 1

MODULE_LIST=$(/usr/bin/ls /usr/lib/modules)

for KERNEL in "${KERNELS[@]}"; do
	for MODULE in $(
		# Listamos todos los modulos del kernel correspondiente
		echo "$MODULE_LIST" | grep "$KERNEL$" |
			# Excluimos el kernel más reciente y el que se está usando
			head -n -1 | grep -v "$(uname -r)"
	); do
		rm -rf "/usr/lib/modules/$MODULE"
	done
done

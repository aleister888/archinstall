#!/bin/bash

# Script para cambiar el brillo

SOUND="/usr/share/sounds/freedesktop/stereo/audio-volume-change.oga"
LEVELS=10 # Número de niveles de brillo

# Establecer el dispositivo en función de la CPU
if grep -q "GenuineIntel" /proc/cpuinfo; then
	BRIGHT_DEV="/sys/class/backlight/intel_backlight"
elif grep -q "AMD" /proc/cpuinfo; then
	BRIGHT_DEV="/sys/class/backlight/amdgpu_bl1"
else
	exit 1
fi

[ ! -e "$BRIGHT_DEV/brightness" ] && exit 1

MAX_BRIGHTNESS=$(cat "$BRIGHT_DEV/max_brightness")
CURRENT_BRIGHTNESS=$(cat "$BRIGHT_DEV/brightness")

# Crear un array con todos los niveles de brillo posibles
STEPS=$(((MAX_BRIGHTNESS + LEVELS - 1) / LEVELS)) # Redondeo hacia arriba
LEVELS_ARRAY=()
for ((i = 1; i <= LEVELS; i++)); do
	VALUE=$((STEPS * i))
	[[ $VALUE -gt MAX_BRIGHTNESS ]] && VALUE=$MAX_BRIGHTNESS
	LEVELS_ARRAY+=("$VALUE")
done

# Encontramos el nivel actual
INDEX=0
for ((i = 0; i < LEVELS; i++)); do
	if [[ "${LEVELS_ARRAY[i]}" -ge "$CURRENT_BRIGHTNESS" ]]; then
		INDEX=$i
		break
	fi
done

# Ajustamos el índice según acción
case "$1" in
inc)
	((INDEX++))
	[[ $INDEX -ge LEVELS ]] && exit 1
	;;
dec)
	((INDEX--))
	[[ $INDEX -lt 0 ]] && exit 1
	;;
*) exit ;;
esac

NEXT=${LEVELS_ARRAY[$INDEX]}

echo "$NEXT" | sudo /usr/bin/tee "$BRIGHT_DEV/brightness" >/dev/null
pw-play "$SOUND" &

PERC=$(((INDEX + 1) * 100 / LEVELS))
$HIDE_NOTIFICATIONS &
notify-send -e "Brillo: $PERC%" -t 500 --hint=INT:value:$PERC &

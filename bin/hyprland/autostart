#!/bin/bash
# shellcheck disable=SC1091,SC2155

# Script Iniciador del entorno de escritorio
# por aleister888 <pacoe1000@gmail.com>

source "$REPO_DIR/assets/shell/shell-utils"

set +e

export XDG_RUNTIME_DIR=/run/user/$(id -u)

# Cerrar instancias previas del script
TMP_DIR="$(get_tmp hyprland_autostart)"
PROCESSLIST=$TMP_DIR/startScript_processes

grep -v "^$BASHPID$" "$PROCESSLIST" | while read -r ID; do
	kill -9 "$ID" 2>/dev/null
done
echo $BASHPID | tee "$PROCESSLIST" >/dev/null

#-------------------------------------------------------------------------------

# Directorio de descargas (firefox)
ensure_dir /tmp/01_firefox_downloads >/dev/null

[ -x /usr/bin/joycond ] && ! pgrep -x joycond && setsid -f /usr/bin/joycond
[ -x /usr/bin/joycond-cemuhook ] && ! pgrep -f joycond-cemuhook && setsid -f /usr/bin/joycond-cemuhook

# Corregir el nivel del micr칩fono en port치tiles
if [ -e /sys/class/power_supply/BAT0 ]; then
	sleep 10 # Esperamos a que carguen los sinks reales

	MIC=$(pactl list short sources |
		grep -E "alsa_input.pci-[0-9]*_[0-9]*_[0-9].\.[0-9].analog-stereo" |
		awk '{print $1}')

	while true; do
		pactl set-source-volume "$MIC" 25%
		sleep 0.5
	done
fi &

# Si hay una tarjeta de audio USB y hay VST instalados, abrimos REAPER
if lsusb | grep -i audio &&
	[ -e "$WINEPREFIX/drive_c/Program Files/Common Files/VST3" ]; then
	setsid -f "$HOME/.local/bin/utils/reaper-xephyr"
fi

cleaner

# Watchers
#-------------------------------------------------------------------------------

# Actualizar el fondo de pantalla
while true; do
	inotifywait -e modify ~/.dotfiles/assets/images/wallpaper
	pkill hyprpaper
	setsid -f hyprpaper
done &

# Recargar la configuraci칩n de swaync
while true; do
	inotifywait -e modify ~/.config/swaync
	systemctl --user restart swaync.service
	notify-send -i preferences-system-notifications "swaync" "Configuraci칩n actualizada"
done &

# Asegurarse de que el polkit agent esta siempre activo
while true; do
	POLKIT_STATUS="$(systemctl --user show hyprpolkitagent | grep ActiveState | cut -d'=' -f2)"
	[ "$POLKIT_STATUS" != "active" ] && systemctl --user restart hyprpolkitagent
done &

wait

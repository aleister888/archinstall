#!/bin/bash
# shellcheck disable=SC1091

# Script Iniciador del entorno de escritorio
# por aleister888 <pacoe1000@gmail.com>

source "$HOME/.dotfiles/.profile"
# Leemos nuestro perfil de zsh
. "$XDG_CONFIG_HOME/zsh/.zprofile"

XDG_RUNTIME_DIR=/run/user/$(id -u)
export XDG_RUNTIME_DIR

# Cerrar instancias previas del script
PROCESSLIST=/tmp/startScript_processes
MY_ID=$BASHPID

grep -v "^$MY_ID$" "$PROCESSLIST" | while read -r ID; do
	kill -9 "$ID" 2>/dev/null
done

echo $MY_ID | tee $PROCESSLIST >/dev/null

##########
# Script #
##########

# Joycond para emuladores
if [ -x /usr/bin/joycond ] && ! pgrep -x joycond; then
	/usr/bin/joycond &
fi
if [ -x /usr/bin/joycond-cemuhook ] && ! pgrep -f joycond-cemuhook; then
	/usr/bin/joycond-cemuhook &
fi

# Corregir el nivel del micrófono en portátiles
if [ -e /sys/class/power_supply/BAT0 ]; then
	sleep 10 # Esperamos para que se carguen los sinks reales

	MIC=$(pactl list short sources |
		grep -E "alsa_input.pci-[0-9]*_[0-9]*_[0-9].\.[0-9].analog-stereo" |
		awk '{print $1}')

	while true; do
		pactl set-source-volume "$MIC" 20%
		sleep 0.5
	done
fi &

# Iniciar hydroxide si está instalado
# https://github.com/emersion/hydroxide?tab=readme-ov-file#usage
[ -x /usr/bin/hydroxide ] && hydroxide imap &

# Si hay una tarjeta de audio USB y hay VST instalados, abrimos REAPER
if lsusb | grep -i audio &&
	[ -e "$WINEPREFIX/drive_c/Program Files/Common Files/VST3" ]; then
	setsid -f /usr/bin/reaper
fi

# Limpiar directorio $HOME
cleaner

############
# Watchers #
############

# Actualizar el fondo de pantalla automáticamente
while true; do
	inotifywait -e modify ~/.dotfiles/assets/images/wallpaper
	pkill hyprpaper
	setsid -f hyprpaper
done &

# Recargar la configuración de swaync
while true; do
	inotifywait -e modify ~/.config/swaync
	systemctl --user restart swaync.service
	notify-send -i preferences-system-notifications "swaync" "Configuración actualizada"
done &

while true; do
	POLKIT_STATUS="$(systemctl --user show hyprpolkitagent | grep ActiveState | cut -d'=' -f2)"
	[ "$POLKIT_STATUS" != "active" ] &&
		systemctl --user restart hyprpolkitagent
done &

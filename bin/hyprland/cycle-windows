#!/bin/bash

# Cambiamos el foco de las ventanas de forma cíclica en función de si estamos en
# un espacio normal o en el espacio especial "scratch"

ARG="$1"
[ -z "$ARG" ] && exit 1

# Indexamos la dirección de las ventanas en el espacio "special:scratch"
# ordenadas en función de la última vez que tuvieron el foco (No usamos el PID
# porque todas las ventanas de kitty que usan --single-instance tienen el mismo
# pid)
index_scratch_addresses() {
	mapfile -t SCRATCH_ADDRESSES < <(
		hyprctl -j clients |
			jq -r '.[]
			| select(.workspace.name=="special:scratch")
			| select(.floating == true and .fullscreen == 0)
			| "\(.focusHistoryID):\(.address)"' |
			sort | cut --delimiter=":" --fields="2"
	)
}

get_prop_from_address() {
	hyprctl -j clients | jq -r ".[] | select(.address == $1) | .$2"
}

focus_from_address() {
	hyprctl dispatch focuswindow "address:$1"
	hyprctl dispatch alterzorder top, "address:$1"
}

cycle_regular() {
	if [ "$ARG" = "prev" ]; then
		hyprctl dispatch layoutmsg cycleprev
	elif [ "$ARG" = "next" ]; then
		hyprctl dispatch layoutmsg cyclenext
	fi
}

cycle_scratch() {
	index_scratch_addresses
	# Última ventana enfocada cronológicamente
	local ADDRESS="${SCRATCH_ADDRESSES[-1]}"

	focus_from_address "$ADDRESS"
}

case "$(hyprctl -j activewindow | jq -r '.workspace.name')" in
"special:scratch") cycle_scratch ;;
*) cycle_regular ;;
esac

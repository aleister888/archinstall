#!/bin/bash -x

# Cambiamos el foco de las ventanas de forma cíclica en función de si estamos en
# un espacio normal o en el espacio especial "scratch"

SCRATCH_PIDS=()

ARG="$1"
[ -z "$ARG" ] && exit 1

ACTIVE_WORKSPACE=$(hyprctl -j activewindow | jq -r '.workspace.name')

# Indexamos el PID de las ventanas en el espacio "special:scratch" ordenadas
# en función de la última vez que tuvieron el foco
index_scratch() {
	mapfile -t SCRATCH_PIDS < <(
		hyprctl -j clients |
			jq -r '.[]
				| select( .workspace.name=="special:scratch")
				| select(.fullscreen == 0)
				| "\(.focusHistoryID):\(.pid)"' |
			sort | cut -d':' -f2
	)
}

cycle_regular() {
	if [ "$ARG" = "prev" ]; then
		hyprctl dispatch layoutmsg cycleprev
	elif [ "$ARG" = "next" ]; then
		hyprctl dispatch layoutmsg cyclenext
	fi
}

cycle_scratch() {
	index_scratch
	local PID="${SCRATCH_PIDS[-1]}"
	# Enfocamos la última ventana enfocada de la lista
	hyprctl dispatch focuswindow "pid:$PID"
	hyprctl dispatch alterzorder top,"pid:$PID"
}

# Si estamos en un espacio normal cambiamos ventanas con layoutmsg
if [ "$ACTIVE_WORKSPACE" != "special:scratch" ]; then
	cycle_regular
# Si estamos en el espacio especial "scratch" vamos alternando el foco entre
# los distintos scratchpads
else
	cycle_scratch
fi

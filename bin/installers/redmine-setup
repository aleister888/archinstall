#!/bin/bash
# shellcheck disable=SC2086,SC2155,SC2164,SC3043

# Instala y configura redmine con usuario=admin contraseña=admin

set -e

[ -z "${MYSQL_PASSWD}" ] && MYSQL_PASSWD=mysql
[ -z "${REDMINE_PASSWD}" ] && REDMINE_PASSWD=redmine

mysql_install() {
	sudo /usr/bin/pacman -Sy --noconfirm --needed mariadb
	sudo /usr/bin/mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
	sudo /usr/bin/systemctl enable --now mariadb

	# Password configuration.
	cat <<-EOF | sudo /usr/bin/mariadb-secure-installation

		y
		${MYSQL_PASSWD}
		${MYSQL_PASSWD}
		n
		y
		y
		y
	EOF

	# Create user and database for redmine.
	cat <<-EOF | sudo /usr/bin/mariadb -uroot -p${MYSQL_PASSWD}
		CREATE DATABASE redmine CHARACTER SET UTF8;
		CREATE USER 'redmine'@'localhost' IDENTIFIED BY '${REDMINE_PASSWD}';
		GRANT ALL PRIVILEGES ON redmine.* TO 'redmine'@'localhost';
	EOF
}

redmine_service_install() {
	sudo /usr/bin/pacman -Sy --noconfirm --needed redmine ruby-bundler postgresql-libs

	# Ruby on Rails.
	cd /usr/share/webapps/redmine/

	cat <<-EOF | sudo /usr/bin/tee config/database.yml
		production:
		  adapter: mysql2
		  database: redmine
		  host: localhost
		  username: redmine
		  password: "${REDMINE_PASSWD}"
		  encoding: utf8
	EOF

	sudo /usr/bin/chown -R http:http /usr/share/webapps/redmine/
	sudo /usr/bin/chmod -R 755 /usr/share/webapps/redmine/

	sudo -u http /usr/bin/bundle config set --local frozen false
	sudo -u http /usr/bin/bundle install --path vendor/bundle

	sudo /usr/bin/bundle exec rake generate_secret_token

	sudo /usr/bin/chown -R http:http db

	sudo -u http -g http RAILS_ENV=production /usr/bin/bundle exec rake db:migrate

	sudo -u http -g http RAILS_ENV=production REDMINE_LANG=es \
		/usr/bin/bundle exec rake redmine:load_default_data

	sudo /usr/bin/sed -i "s/127.0.0.1/0.0.0.0/" \
		/usr/lib/systemd/system/redmine.service # Permitimos el acceso remoto

	sudo /usr/bin/systemctl daemon-reload
	sudo /usr/bin/systemctl enable --now redmine.service
}

repo_install() {
	local NAME="$(basename "$1")"
	local INSTALL_DIR="/usr/share/webapps/redmine/$2/$NAME"
	local TMP_DIR="/tmp/$NAME"

	[ -d "$INSTALL_DIR" ] && return
	[ -d "$TMP_DIR" ] && rm -rf "$TMP_DIR"

	git clone "https://github.com/$1.git" \
		"$TMP_DIR"

	sudo /usr/bin/cp -r "$TMP_DIR" "$INSTALL_DIR"
	sudo /usr/bin/chown -R http:http "$INSTALL_DIR"
}

themes_install() {
	THEMES=(
		"gagnieray/opale"
	)
	for THEME in "${THEMES[@]}"; do
		repo_install $THEME themes
	done
}

redmine_install() {
	mysql_install
	redmine_service_install
	themes_install
}

redmine_backup() {
	local BACKUP_DIR="$1"

	mkdir -p "$BACKUP_DIR"

	[ ! -d "$BACKUP_DIR" ] && {
		echo "$BACKUP_DIR no es un directorio válido" >&2
		help_msg
	}

	echo "Creando copia de seguridad en: $BACKUP_DIR"

	# Hacemos una copia de seguridad de la base de datos CON eliminación manual
	{
		# Cabecera del dump
		echo "-- Redmine Backup"
		echo "-- Generated: $(date)"
		echo "-- Database: redmine"
		echo ""
		# Eliminación completa de la base de datos
		echo "/*!40000 DROP DATABASE IF EXISTS redmine */;"
		echo "CREATE DATABASE redmine CHARACTER SET UTF8;"
		echo "USE redmine;"
		echo ""
		# Dump de la estructura y datos
		mariadb-dump -u redmine -p"${REDMINE_PASSWD}" \
			--no-create-db \
			--complete-insert \
			--extended-insert \
			--single-transaction \
			redmine
	} >"$BACKUP_DIR/database.sql"

	# Hacemos una copia de seguridad de los archivos
	rsync -av --delete /var/lib/redmine/files/ "$BACKUP_DIR/files/" >/dev/null 2>&1
	rsync -av --delete /usr/share/webapps/redmine/themes/ "$BACKUP_DIR/themes/" >/dev/null 2>&1
}

tmp_backup() {
	# Aquí crearemos una copia de como estaba redmine antes de la restauración
	local RESTORE_DIR="/tmp/redmine_backup_$(date +%Y%m%d_%H%M%S)"

	# Creamos una copia de seguridad temporal en caso de fallo
	redmine_backup $RESTORE_DIR

}

redmine_restore() {
	# Directorio donde se aloja la copia de seguridad
	local BACKUP_DIR="$1"

	# Nos aseguramos de que el directorio contega un backup
	[ ! -e "$BACKUP_DIR/database.sql" ] && {
		echo "El directorio no contiene una copia de seguridad" >&2
		exit 1
	}

	tmp_backup

	# Detenemos el servicio
	echo "Deteniendo redmine"
	sudo /usr/binsystemctl stop redmine.service && echo "Servicio redmine detenido"

	# Restauramos la copia de seguridad de la base de datos y archivos
	echo "Restaurando copia de seguridad desde: $BACKUP_DIR"
	sudo /usr/bin/mariadb <<-EOF
		DROP DATABASE IF EXISTS redmine
	EOF
	mariadb -u redmine -p"${REDMINE_PASSWD}" <"$BACKUP_DIR/database.sql"

	sudo /usr/bin/rsync -av --delete "$BACKUP_DIR/files/" /var/lib/redmine/files/ >/dev/null 2>&1
	sudo /usr/bin/rsync -av --delete "$BACKUP_DIR/themes/" /usr/share/webapps/redmine/themes/ >/dev/null 2>&1

	sudo /usr/bin/chown -R http:http /var/lib/redmine/files
	sudo /usr/bin/chown -R http:http /usr/share/webapps/redmine/themes

	echo "Reiniciando redmine"
	if sudo /usr/bin/systemctl restart redmine.service; then
		echo "redmine reinciado correctamente"
	else
		echo "Error al reiniciar redmine"
	fi
}

clean() {
	sudo /usr/bin/systemctl stop redmine
	tmp_backup

	mariadb -u redmine -p"${REDMINE_PASSWD}" redmine <<-EOF
		DELETE FROM journal_details;
	EOF

	sudo /usr/bin/systemctl start redmine
}

help_msg() {
	echo "Uso: $(basename "$0"):" >&2
	echo "       --install" >&2
	echo "       --backup  [CARPETA]" >&2
	echo "       --restore [CARPETA]" >&2
	exit 1
}

# Manejo de argumentos
case "$1" in
--install) redmine_install ;;
--backup) redmine_backup "$2" ;;
--restore) redmine_restore "$2" ;;
--themes) themes_install ;;
--clean) clean ;;
*) help_msg ;;
esac

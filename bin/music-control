#!/bin/sh -x

# Script para controlar la reproducción de la música

# Si se ejecuta con -q el script no notifica
QUIET=false
if [ "$1" = "-q" ]; then
	QUIET=true
	shift
fi

# Reemplazar caracteres conflictivos para pango markup
escape_markup() {
	sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g;'
}

# Establecemos el reproductor
PLAYER="$(music-priority)"

# Si no se encontró el reproductor, se informa al usuario
if [ -z "$PLAYER" ] && ! $QUIET; then
	$HIDE_NOTIFICATIONS
	notify-send -e -i "$(music-metadata -c)" \
		"$(music-metadata -t)" "$(music-metadata -a)"
# Si se encontró, notificamos el cambio de canción
else
	export ALTFACT=34
	playerctl --player="$PLAYER" "$1"

	if [ "$1" != "play-pause" ] && ! $QUIET; then
		$HIDE_NOTIFICATIONS
		TITLE="$(music-metadata -S -t | escape_markup)"
		ARTIST="$(music-metadata -S -a | escape_markup)"
		ALBUM="<i>$(music-metadata -S -A | escape_markup)</i>"

		notify-send -e -i "$(music-metadata -c)" \
			"$TITLE" "$ARTIST\n$ALBUM"
	fi
fi

#!/bin/sh -x

# Script para controlar la reproducción de la música

# Si se ejecuta con -q el script no notifica
QUIET=false
if [ "$1" = "-q" ]; then
	QUIET=true
	shift
fi

# Reemplazar caracteres conflictivos para pango markup
escape_markup() {
	sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g;'
}

# Establecemos el reproductor
PLAYER="$(music-priority)"

# Si no se encontró el reproductor, se informa al usuario
if [ -z "$PLAYER" ] && ! $QUIET; then
	makoctl dismiss -a
	notify-send -i "$(music-metadata -c)" \
		"$(music-metadata -t)" "$(music-metadata -a)"
# Si se encontró, notificamos el cambio de canción
else
	export ALTFACT=26
	playerctl --player="$PLAYER" "$1"

	if [ "$1" != "play-pause" ] && ! $QUIET; then
		makoctl dismiss -a
		TITLE="$(music-metadata -S -t | escape_markup)"
		ARTIST="<span font='12'>$(music-metadata -S -a | escape_markup)</span>"
		LINE_BREAK="<span font='4'>\n\n</span>"
		ALBUM="<span font='10'>$(music-metadata -S -A | escape_markup)</span>"

		notify-send -i "$(music-metadata -c)" \
			"$TITLE" "$ARTIST$LINE_BREAK$ALBUM"
	fi
fi

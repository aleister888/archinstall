#!/bin/sh -x

# Controlar la reproducción de la música

[ "$(pgrep "$(basename "$0")" | wc -l)" -ge 3 ] && exit 1

QUIET=false
if [ "$1" = "-q" ]; then
	QUIET=true
	shift
fi

# Reemplazar caracteres conflictivos para pango markup
escape_markup() {
	sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g;'
}

PLAYER="$(music-priority)"

if [ -z "$PLAYER" ] && ! $QUIET; then
	$HIDE_NOTIFICATIONS
	notify-send -e -i "$(music-metadata -c)" \
		"$(music-metadata -t)" "$(music-metadata -a)"
else
	export ALTFACT=28
	playerctl --player="$PLAYER" "$1"

	if [ "$1" != "play-pause" ] && ! $QUIET; then
		$HIDE_NOTIFICATIONS
		TITLE="$(music-metadata -S -t | escape_markup)"
		ARTIST="$(music-metadata -S -a | escape_markup)"
		ALBUM="<i>$(music-metadata -S -A | escape_markup)</i>"

		notify-send -e -i "$(music-metadata -c)" \
			"$TITLE" "$ARTIST\n$ALBUM"
	fi
fi

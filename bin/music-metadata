#!/bin/bash

shopt -s extglob

# Número máximo de caracteres del output
[ -z "$FACT" ] && FACT=26
[ -z "$ALTFACT" ] && ALTFACT=12

# Establecemos el reproductor
PLAYER="$(music-priority)"
# Si la música se está reproduciendo en el navegador, esperamos un tiempo
[ "$PLAYER" = "$BROWSER" ] && sleep 1

makesafe() {
	if [ "${#1}" -gt "$FACT" ]; then
		local CROPPED="${1:0:$((FACT - 3))}"
		echo "${CROPPED% }… "
	else
		[ -z "$1" ] || echo "$1"
	fi
}

statusbar() {
	[ -z "$PLAYER" ] && exit

	local TITLE ARTIST STATUS INDICATOR

	# Obtener el título de la canción y estado de la reproducción
	TITLE=$(metaprint title)
	ARTIST=$(metaprint artist)
	STATUS="$(playerctl status --player="$PLAYER")"

	[ -z "$TITLE" ] && exit

	if [ "$STATUS" == "Playing" ]; then
		INDICATOR="Playing:"
	elif [ -n "$STATUS" ]; then
		INDICATOR="Paused:"
	fi
	INDICATOR="<b>$INDICATOR</b>"

	echo "$INDICATOR <i>$TITLE - $ARTIST</i>"
}

metaprint() {
	local OUT

	if [ -z "$PLAYER" ]; then
		case "$1" in
		title) OUT="Reproductor cerrado" ;;
		album) OUT="No se pudo obtener la información" ;;
		artist) OUT="No se pudo obtener la información" ;;
		esac
	else
		case "$1" in
		title | album | artist)
			OUT="$(playerctl metadata --player="$PLAYER" "$1")"
			;;
		esac
	fi

	[ -z "$OUT" ] && exit 1

	[ "$WITHSAFE" == "true" ] && OUT=$(makesafe "$OUT")

	echo "${OUT%%+([[:space:]])}"
}

help_msg() {
	echo "Uso:
  $(basename "$0") [-Sdtacsh]

OPCIONES:
  -S	Habilitar máximo de caracteres ($FACT para -d, $ALTFACT para -t/-a/-A)
  -d	Imprimir información para la barra de estado (-S activado)
  -t	Imprime el titulo
  -a	Imprime el artista
  -A	Imprime el álbum
  -c	Imprime la localización en cache de la caratula o un placeholder si no encuentra ninguno
  -s	Imprime el estado de la reproducción
  -h	Muestra este mensaje

NOTA:
  Puedes cambiar el máximo de caracteres para -d con la variable \$FACT y el máximo para -t/-a con la variable \$ALTFACT" >&2
}

if echo "$@" | grep "\-h\|--help" >/dev/null; then
	help_msg
	exit
fi

while [[ "$#" -gt 0 ]]; do
	case "$1" in
	-S)
		WITHSAFE=true
		;;
	-d)
		WITHSAFE=true
		statusbar
		exit
		;;
	-t)
		FACT=$ALTFACT
		metaprint title
		exit
		;;
	-a)
		FACT=$ALTFACT
		metaprint artist
		exit
		;;
	-A)
		FACT=$ALTFACT
		metaprint album
		exit
		;;
	-c)
		COVER=$(playerctl --player="$PLAYER" metadata mpris:artUrl)
		if [ -z "$COVER" ]; then
			echo "$HOME/.dotfiles/assets/images/music-control_placeholder.png"
		else
			if [ "$PLAYER" == "tauon" ]; then
				echo "${COVER#file://}"
			elif [[ $COVER =~ ^https:// ]]; then
				TMP_COVER="/tmp/music-metadata"
				wget "$COVER" -O "$TMP_COVER"
				echo "$TMP_COVER"
			else
				echo "$COVER"
			fi
		fi
		exit
		;;
	-s)
		[ -n "$PLAYER" ] && playerctl status --player="$PLAYER"
		exit
		;;
	*)
		help_msg
		exit
		;;
	esac
	shift
done

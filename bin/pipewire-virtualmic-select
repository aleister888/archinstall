#!/bin/bash
# shellcheck disable=SC2086

DMENU="wofi --show dmenu"

# Script para vincular (dispositivos de entrada)|(aplicaciones) a un micrófono virtual para compartir audio

# Sink del micrófono virtual
SINK_L=my-combined-sink:playback_FL
SINK_R=my-combined-sink:playback_FR

# Variables para las notificaciones
ICON="bridge-constructor"
MSG="Micrófono Virtual"

# Excluiremos los sinks cuyo nombre contenga alguno de estos patrones
EXCLUDE_PATTERN="my-combined-sink\|my-virtualmic\|PulseAudio\|Midi\|v4l2\|WEBRTC\|Chromium"

# Dispositivos/aplicaciones a elegir (borrar)
DEL_DEVICES=$(
	pw-link -l my-combined-sink |
		pcre2grep -M 'my-combined-sink:playback_F[LR]\n(^ .*\n)*' |
		grep -oP '\- \K.*'
)

# Dispositivos/aplicaciones a elegir (añadir)
DEVICES=$(
	pw-link -o |
		grep -P ':((capture)|(output)_((FL)|(FR)|(MONO)))|(out[12])' |
		grep -v "$EXCLUDE_PATTERN" | sort -u
)

# Borrar de las entradas a añadir las que ya están vinculadas
for ADDED in $DEL_DEVICES; do
	DEVICES=$(echo "$DEVICES" | grep -v "$ADDED")
done

sink_link() {
	local FLAG
	local CSELECTED
	[ "$1" = "del" ] && FLAG="-d"

	case "$SELECTED" in
	*FL) CSELECTED="${SELECTED%FL}FR" ;;
	*FR) CSELECTED="$SELECTED" SELECTED="${SELECTED%FR}FL" ;;
	*1) CSELECTED="${SELECTED%1}2" ;;
	*2) CSELECTED="$SELECTED" SELECTED="${SELECTED%2}1" ;;
	*) CSELECTED="$SELECTED" ;;
	esac

	timeout -k 1s 3s pw-link $FLAG "$SELECTED" "$SINK_L"
	timeout -k 1s 3s pw-link $FLAG "$CSELECTED" "$SINK_R"
}

# Función para vincular/desvincular dispositivos/aplicaciones
sink_edit() {
	local DMENU_SELECTED

	# Lista con nuestros dispositivos/aplicaciones
	if [ "$1" = "add" ]; then
		SINKS=$DEVICES
	else
		SINKS=$DEL_DEVICES
	fi

	F_SINKS=$(echo "$SINKS" | sed 's/:.*//g' | sort -u)

	# Elegir el sink con dmenu mostrando solo la información esencial
	DMENU_SELECTED=$(echo "$F_SINKS" | $DMENU --lines "$(echo "$F_SINKS" | wc -l)")
	if [ -z "$DMENU_SELECTED" ]; then
		# Salir del script si no se eligió ninguna opción
		exit
	else
		# Elegir la primera coincidencia de nuestra elección con el array
		SELECTED=$(echo "$SINKS" | grep "$DMENU_SELECTED" | sed '1q;d')
	fi

	if [ -z "$SELECTED" ]; then
		exit
	elif [ "$1" = "add" ]; then # Vincular dispositivos/aplicaciones
		# Comprobar que los dispositivos/aplicaciones se añadieron correctamente
		if sink_link "$1" && pw-link -l | grep "my-combined-sink" -A 1 | grep "$DMENU_SELECTED" >/dev/null; then
			notify-send -e -i $ICON "$MSG" "Sink vinculado correctamente"
		else
			notify-send -e -i $ICON "$MSG" "Hubo un fallo al añadir el sink"
		fi
	elif [ "$1" = "del" ]; then # Desvincular dispositivos/aplicaciones
		sink_link "$1" && notify-send -e -i $ICON "$MSG" "Sink borrado"
	fi
}

# Elegir si vincular o desvincular sinks
ADD="Añadir sink al micrófono virtual"
DEL="Quitar sink del micrófono virtual"
CHOSEN=$(echo -e "$ADD\n$DEL" | eval $DMENU -L 2)
if [ "$CHOSEN" = "$ADD" ]; then
	[ -z "$DEVICES" ] &&
		notify-send -e -i $ICON "$MSG" "No hay sinks que añadir" && exit
	sink_edit add
elif [ "$CHOSEN" = "$DEL" ]; then
	[ -z "$DEL_DEVICES" ] &&
		notify-send -e -i $ICON "$MSG" "No hay sinks que borrar" && exit
	sink_edit del
fi

#!/bin/bash
# shellcheck disable=SC1091

source "$HOME/.dotfiles/assets/shell/shell-utils"

TMP_DIR="$(get_tmp plot_macros)"
CACHE_FILE="$XDG_CACHE_HOME/plot-macros"

# Crear gráficos de barras para cada macro-nutriente
make_plot() {
	local VALUE=$1  # Calorías/Gramos consumidos
	local GOAL=$2   # Calorías/Gramos objetivo
	local TITLE=$3  # Título del gráfico
	local COLOR=$4  # Color de la barra
	local OUTPUT=$5 # Archivo de salida

	gnuplot >/dev/null 2>&1 <<-EOF
		set terminal pngcairo size 400,400 enhanced font 'Verdana,12'
		set output '$OUTPUT'
		set title "$TITLE"
		unset key
		unset ylabel
		set style data histogram
		set style fill solid border -1
		set boxwidth 0.4
		set yrange [0:$(echo "$GOAL * 1.75" | bc)]

		set arrow from graph 0, first $GOAL to graph 1, \
			first $GOAL nohead lc rgb "black" lw 2 dashtype 2 front

		plot '-' using 2:xtic(1) lc rgb "$COLOR" with boxes title "$TITLE", \
		     ''  using 6 lc rgb "$COLOR" dt 2 title "$TITLE Objetivo"
		"" $VALUE
		e
	EOF
}

help_msg() {
	cat <<-EOF
		USO: $(basename "$0") [-oh] <COMIDAS.csv> <MACROS_OBJETIVO.csv>

		OPCIONES:
		  -o Vuelve a procesar las entradas de los días anteriores
		     (por defecto solo lo hace para los no días no procesados)
		  -h Muestra este mensaje
	EOF
}

OVERWRITE="false"

while getopts "oh" OPT; do
	case $OPT in
	o)
		OVERWRITE="true"
		;;
	h)
		help_msg
		exit 0
		;;
	*)
		help_msg >&2
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

if [ -f "$CACHE_FILE" ]; then
	INPUT_FILE=$(head -n1 <"$CACHE_FILE")
	TARGET_MACROS=$(tail -n1 <"$CACHE_FILE")
else
	# Guardamos en cache los archivos con las macros objetivo y diarias.
	INPUT_FILE=$1
	TARGET_MACROS=$2
	[ -f "$INPUT_FILE" ] && echo "$INPUT_FILE" >"$CACHE_FILE"
	[ -f "$TARGET_MACROS" ] && echo "$TARGET_MACROS" >>"$CACHE_FILE"
fi

[ ! -f "$INPUT_FILE" ] || [ ! -f "$TARGET_MACROS" ] && {
	help_msg >&2
	exit 1
}

DIRECTORY=$(dirname "$INPUT_FILE")
PROCESSED_MACROS="${DIRECTORY}/processed_macros.csv"

[ ! -f "$PROCESSED_MACROS" ] && OVERWRITE="true"

if [ $OVERWRITE = "true" ]; then
	echo "date,calories,fat,carbs,protein" >"$PROCESSED_MACROS"
else
	SECOND_LAST_PROC_DATE=$(tail -n 2 "$PROCESSED_MACROS" | head -n 1 | cut -d',' -f1)
fi

LAST_PROC_DATE=$(tail -n 1 "$PROCESSED_MACROS" | cut -d',' -f1)

declare -A DAILY_DATA

# Procesamos los datos
#-------------------------------------------------------------------------------

# Leemos en orden inverso para no procesar información innecesaria si
# OVERWRITE=false
while IFS=',' read -r DATE _ _ _ CAL FAT CARBS PROT PROT_PERC; do

	# Ajustamos a el porcentaje de proteina completa
	[[ -n "$PROT_PERC" ]] && {
		PROT_CALC=$(awk "BEGIN { print $PROT * $PROT_PERC }" 2>/dev/null) &&
			PROT=$PROT_CALC
	}

	# OVERWRITE=false => paramos al llegar al penúltimo día procesado
	[ $OVERWRITE = "false" ] && [ "$DATE" = "$SECOND_LAST_PROC_DATE" ] && break

	# Cuando tenemos varias entradas por día, sumamos los valores
	IFS=',' read -r OLD_CAL OLD_FAT OLD_CARBS OLD_PROT <<<"${DAILY_DATA[$DATE]-0,0,0,0}"

	OLD_CAL=${OLD_CAL:-0}
	OLD_FAT=${OLD_FAT:-0}
	OLD_CARBS=${OLD_CARBS:-0}
	OLD_PROT=${OLD_PROT:-0}
	CAL=${CAL:-0}
	FAT=${FAT:-0}
	CARBS=${CARBS:-0}
	PROT=${PROT:-0}

	# shellcheck disable=SC2046
	read -r NEW_CAL NEW_FAT NEW_CARBS NEW_PROT <<<"$(
		bc <<<"$OLD_CAL+$CAL
			$OLD_FAT+$FAT
			$OLD_CARBS+$CARBS
			$OLD_PROT+$PROT" | tr '\n' ' '
	)"

	DAILY_DATA[$DATE]="$NEW_CAL,$NEW_FAT,$NEW_CARBS,$NEW_PROT"
done < <(
	tac ~/Documentos/Gym/diet/comidas.csv | sed '$d'
)

# Tabulamos los datos
#-------------------------------------------------------------------------------

for DATE in $(printf "%s\n" "${!DAILY_DATA[@]}" | sort); do
	IFS=',' read -r CAL FAT CARB PROT <<<"${DAILY_DATA[$DATE]}"

	# En vez de reescribir todo el archivo, modificamos solo la fecha
	# actualizada si ya estaba
	if [ "$OVERWRITE" = "false" ] && [ "$DATE" = "$LAST_PROC_DATE" ]; then
		sed -i "/^$DATE,/c\\$DATE,$CAL,$FAT,$CARB,$PROT" "$PROCESSED_MACROS"
	else
		LC_NUMERIC=en_US.UTF-8 printf "%s,%s,%s,%s,%s\n" \
			"$DATE" "$CAL" "$FAT" "$CARB" "$PROT" >>"$PROCESSED_MACROS"
	fi
done

# Gráfico de barras (Último día)
#-------------------------------------------------------------------------------

IFS=, read -r CAL_TARGET FAT_TARGET CARB_TARGET PROT_TARGET < <(
	tail -n +2 "$TARGET_MACROS"
)

IFS=',' read -r _ CAL FAT CARBS PROT _ < <(tail -n 1 "$PROCESSED_MACROS")
make_plot "$CAL" "$CAL_TARGET" "Calorías" "#e41a1c" "${TMP_DIR}/calories.png" &
make_plot "$FAT" "$FAT_TARGET" "Grasa (g)" "#377eb8" "${TMP_DIR}/fat.png" &
make_plot "$CARBS" "$CARB_TARGET" "Carbohidratos (g)" "#4daf4a" "${TMP_DIR}/carbs.png" &
make_plot "$PROT" "$PROT_TARGET" "Proteína (g)" "#984ea3" "${TMP_DIR}/protein.png" &
wait

OUTPUT_DAILY_COMBINED="${DIRECTORY}/daily.png"
convert +append \
	"${TMP_DIR}/calories.png" \
	"${TMP_DIR}/fat.png" \
	"${TMP_DIR}/carbs.png" \
	"${TMP_DIR}/protein.png" \
	"$OUTPUT_DAILY_COMBINED" >/dev/null 2>&1

notify-send -e -i text-csv "$(basename "$0")" "Informe compilado"

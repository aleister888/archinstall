#!/bin/bash

source "$REPO_DIR/assets/shell/shell-utils"

[ "$(pgrep screenshot | wc -l)" -ge 3 ] && exit 1

# Alungas aplicaciones solo pueden pegar del portapapeles si la imagen es png
EXTENSION="png"
FILENAME="$(date +"%Y-%m-%d_%H-%M-%S").$EXTENSION"
SCREENSHOTS_DIR="$HOME/Im√°genes/Screenshots"
FILEPATH=${FILEPATH:-$SCREENSHOTS_DIR/$FILENAME}
SOUND="/usr/share/sounds/freedesktop/stereo/camera-shutter.oga"
TMP_DIR=$(get_tmp screenshots)
TMP="$TMP_DIR/screenshot.$EXTENSION"
MSG="Captura de Pantalla"

mkdir -p "$SCREENSHOTS_DIR"

capture() {
	AREA=$1
	MODE=$2

	if [ "$AREA" = "all" ]; then
		grim -t "$EXTENSION" "$TMP"
	else
		grim -t "$EXTENSION" -g "$(slurp)" "$TMP"
	fi

	if [ -s "$TMP" ]; then
		if [ "$MODE" = "clipboard" ]; then
			wl-copy <"$TMP"
			[ "$QUIET" ] || setsid -f notify-send -e -i "$TMP" "$MSG" "Copiada al Portapapeles"
		else
			mv "$TMP" "$FILEPATH"
			[ "$QUIET" ] || setsid -f notify-send -e -i "$FILEPATH" "$MSG" "$FILENAME"
		fi
		setsid -f pw-play "$SOUND"
	else
		setsid -f notify-send -e -i system-error "$MSG" "Error al capturar"
	fi
}

[ "$2" = "-q" ] && QUIET=true

case "$1" in
all_clip) capture all clipboard ;;
selection_clip) capture selection clipboard ;;
all_save) capture all disk ;;
selection_save) capture selection disk ;;
*) echo "Uso: $0 {all_clip|selection_clip|all_save|selection_save}" && exit 1 ;;
esac

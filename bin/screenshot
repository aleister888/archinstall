#!/bin/bash -x

trap 'rm -f "$TMP"' EXIT

[ "$(pgrep screenshot | wc -l)" -ge 3 ] && exit 1

FILENAME="$(date +"%Y-%m-%d_%H-%M-%S").png"
SCREENSHOTS_DIR="$HOME/Imágenes/Screenshots"
FILEPATH=${FILEPATH:-$SCREENSHOTS_DIR/$FILENAME}
SOUND="/usr/share/sounds/freedesktop/stereo/camera-shutter.oga"
TMP="/tmp/screenshot.png"
MSG="Captura de Pantalla"

mkdir -p "$SCREENSHOTS_DIR"

capture() {
	AREA=$1
	MODE=$2

	if [ "$AREA" = "all" ]; then
		grim "$TMP"
	else
		grim -g "$(slurp)" "$TMP"
	fi

	if [ -s "$TMP" ]; then # El archivo existe y no es vacío
		if [ "$MODE" = "clipboard" ]; then
			# Copiar al portapapeles con wl-copy
			wl-copy <"$TMP"
			[ "$QUIET" ] ||
				notify-send -i "$TMP" "$MSG" "Copiada al Portapapeles"
		else
			mv "$TMP" "$FILEPATH"
			[ "$QUIET" ] ||
				notify-send -i "$FILEPATH" "$MSG" "$FILENAME"
		fi
		pw-play "$SOUND"
	else
		notify-send -i system-error "$MSG" "Error al capturar"
	fi

}

[ "$2" = "-q" ] && QUIET=true

case "$1" in
all_clip) capture all clipboard ;;
selection_clip) capture selection clipboard ;;
all_save) capture all disk ;;
selection_save) capture selection disk ;;
*) echo "Uso: $0 {all_clip|selection_clip|all_save|selection_save}" ;;
esac

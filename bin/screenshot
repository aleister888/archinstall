#!/bin/bash
# shellcheck disable=SC1091,SC2034

source "$HOME/.dotfiles/assets/shell/shell-utils"

[ "$(pgrep screenshot | wc -l)" -ge 3 ] && exit 1

# Alungas aplicaciones solo pueden pegar del portapapeles si la imagen es png
EXTENSION="png"
FILENAME="$(date +"%Y-%m-%d_%H-%M-%S").$EXTENSION"
SCREENSHOTS_DIR="$HOME/Im√°genes/Screenshots"
FILEPATH=${FILEPATH:-$SCREENSHOTS_DIR/$FILENAME}
SOUND="/usr/share/sounds/freedesktop/stereo/camera-shutter.oga"
TMP_DIR=$(get_tmp_dir screenshots)
TMP="$TMP_DIR/screenshot.$EXTENSION"
MSG="Captura de Pantalla"
NOTIFY_TIMEOUT=1400

mkdir -p "$SCREENSHOTS_DIR"

throw_error() {
	setsid -f notify-send -e -i system-error "$MSG" "Error al capturar" -t $NOTIFY_TIMEOUT
	exit 1
}

capture() {
	AREA=$1
	MODE=$2

	if [ "$AREA" = "all" ]; then
		grim -t "$EXTENSION" "$TMP" || throw_error
	else
		grim -t "$EXTENSION" -g "$(slurp)" "$TMP" || throw_error
	fi

	if [ -s "$TMP" ]; then
		if [ "$MODE" = "clipboard" ]; then
			wl-copy <"$TMP"
			[ "$QUIET" ] || setsid -f notify-send -e -i "$TMP" "$MSG" "Copiada al Portapapeles" -t $NOTIFY_TIMEOUT
		else
			mv "$TMP" "$FILEPATH"
			[ "$QUIET" ] || setsid -f notify-send -e -i "$FILEPATH" "$MSG" "$FILENAME" -t $NOTIFY_TIMEOUT
		fi
		#setsid -f pw-play "$SOUND"
	else
		throw_error
	fi
}

[ "$2" = "-q" ] && QUIET=true

case "$1" in
all_clip) capture all clipboard ;;
selection_clip) capture selection clipboard ;;
all_save) capture all disk ;;
selection_save) capture selection disk ;;
*) echo "Uso: $0 {all_clip|selection_clip|all_save|selection_save}" && exit 1 ;;
esac

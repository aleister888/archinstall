#!/bin/sh
# shellcheck disable=SC1091

# Script para instalar los drivers de:
# https://www.asus.com/networking-iot-servers/adapters/all-series/usbbt400/

set -e

. "$HOME/.dotfiles/assets/shell/shell-utils-sh"

DRIVER_URL="https://dlcdnets.asus.com/pub/ASUS/wireless/USB-BT400/DR_USB_BT400_1201710_Windows.zip"
TMP_DIR="$(get_random_tmp)"
ZIP_PATH="$TMP_DIR/bt400-driver.zip"
EXTRACT_PATH="$TMP_DIR/windows_driver"
HEX_FILE="BCM20702A1_001.002.014.1443.1467.hex"
OUT_FILE="/lib/firmware/brcm/BCM20702A1-0b05-17cb.hcd"

if [ -f "$OUT_FILE" ]; then
	log "El driver ya está instalado"
	exit 1
fi

download "$DRIVER_URL" "$ZIP_PATH" >/dev/null

{ lsusb | grep BCM20702A0 | grep -oE '....:....'; } || log "El dispositivo no está conectado" WARN

aunpack "$ZIP_PATH" -X "$EXTRACT_PATH" -f -q

sudo /usr/bin/mkdir -p /lib/firmware/brcm/

# Convertir el archivo .hex a .hcd y moverlo al directorio de firmware
cd "$EXTRACT_PATH/Win10_USB-BT400_DRIVERS/Win10_USB-BT400_Driver_Package/64"
sudo /usr/bin/hex2hcd "$HEX_FILE" -o "$OUT_FILE" >/dev/null 2>&1 &&
	echo "Driver instalado correctamente."

rm -rf "$TMP_DIR"

#!/bin/bash

# Script para ver:
# - Qui√©n de tus FOLLOWS no te sigue de vuelta
# - Tus solicitudes de seguimiento pendientes

# Consigue tu informe de Instagram en:
# https://accountscenter.instagram.com/info_and_permissions/dyi

source "$HOME/.dotfiles/assets/shell/shell-utils"

IN="$1" # Informe de Instagram comprimido
EXTRACT_DIR="$(get_random_tmp)"
LOG_DIR=$(initlog compare_followers)

NOT_FOLLOWING_BACK_TXT="$LOG_DIR/vuelta.txt"
PENDING_TXT="$LOG_DIR/peticiones.txt"

aunpack -fq "$IN" -X "$EXTRACT_DIR"

FOLLOWERS=$(grep -oP 'href="https://www\.instagram\.com/\K[^"]+' \
	"$EXTRACT_DIR/connections/followers_and_following/followers_1.html")
FOLLOWS=$(grep -oP 'href="https://www\.instagram\.com/\K[^"]+' \
	"$EXTRACT_DIR/connections/followers_and_following/following.html")

#-------------------------------------------------------------------------------

NO_FOLLOWERS=$(echo "$FOLLOWS" | grep -Fxv -f <(echo "$FOLLOWERS"))
echo "$NO_FOLLOWERS" >"$NOT_FOLLOWING_BACK_TXT"

PENDING_REQUESTS=$(grep -oP 'href="https://www\.instagram\.com/\K[^"]+' \
	"$EXTRACT_DIR/connections/followers_and_following/pending_follow_requests.html")
echo "$PENDING_REQUESTS" >"$PENDING_TXT"

echo "Informe generado:"
echo "- Usuarios que no te siguen de vuelta guardados en \"$NOT_FOLLOWING_BACK_TXT\""
echo "- Solicitudes de seguimiento pendientes guardadas en \"$PENDING_TXT\""

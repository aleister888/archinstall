#!/bin/bash
# shellcheck disable=SC1091,SC2086,SC2164

# Crear copias de seguridad como archivos comprimidos

source "$HOME/.dotfiles/assets/shell/shell-utils-sh"

DELETE_OLD=false
OG_DIR="$1"
BAK_DIR="$2"
DAYS="${3:-7}"

help_msg() {
	cat <<-EOF
		Uso:
		  $(basename "$0") [-hd] [<directorio_original> <directorio_destino>]

		OPCIONES:
		  -d Borra las copias en el destino con mas de $DAYS dias de antigÃ¼edad
		  -h Muestra este mensaje >&2
	EOF
	exit 1
}

while getopts "dh" opt; do
	case "$opt" in
	d) DELETE_OLD="true" ;;
	h) help_msg ;;
	*) help_msg ;;
	esac
done

ensure_dir "$BAK_DIR" >/dev/null
{ [ ! -d "$OG_DIR" ] || [ ! -d "$BAK_DIR" ]; } && help_msg

EXTENSION="tar.gz"
BAK_NAME="$(date +'%Y-%m-%d_%H-%M-%S').$EXTENSION"

cd "$OG_DIR"
tar -czf "${BAK_DIR}/${BAK_NAME}" .

echo "Copia de seguridad de ${OG_DIR} creada en ${BAK_DIR}/${BAK_NAME}"

[ "$DELETE_OLD" = true ] &&
	find "$BAK_DIR" -type f -name "*.$EXTENSION" -mtime +$DAYS -exec rm {} \;

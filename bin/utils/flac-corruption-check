#!/bin/bash
# shellcheck disable=SC2155,SC1091

# Script para comprobar y corregir la corrupción de los archivos flac de un directorio

source "$HOME/.dotfiles/assets/shell/shell-utils"

OG_DIR="$1" # Directorio a verificar

LOG_DIR=$(init_log flac_corruption)
TMP_LOG="$LOG_DIR/tmp.log"         # Archivos con posibles errores
FINAL_LOG="$LOG_DIR/corrupted.log" # Archivos con corrupción asegurada
RECODE_LOG="$LOG_DIR/recoded.log"  # Falsos positivos que necesitan recodificarse

TMP_DIR=$(get_tmp flac_corruption)
RECODE_TMP_DIR="$(ensure_dir "$TMP_DIR/try")"     # Salida recodificados (temporales)
RECODE_OUT_DIR="$(ensure_dir "$TMP_DIR/recoded")" # Salida recodificados
OVERWRITE=false                                   # Sobrescribir archivos originales

show_help() {
	cat <<-EOF
		Uso: $(basename "$0") [opciones] <directorio>

		OPCIONES:
		  -o, --overwrite     Sobrescribe los archivos originales si son recodificados
		  -h, --help          Muestra este mensaje de ayuda
	EOF
	exit 1
}

while [[ $# -gt 0 ]]; do
	case "$1" in
	-h | --help) show_help ;;
	-o | --overwrite) OVERWRITE=true shift ;;
	*) OG_DIR="$1" shift ;;
	esac
done

[ ! -d "$OG_DIR" ] && exit 1

true >"$TMP_LOG"
true >"$FINAL_LOG"
find "$RECODE_OUT_DIR" -type f -delete

flac_check() {
	local FILE="$1"

	local FLAC_OUTPUT=$(flac -t "$FILE" 2>&1)
	ERROR_PATTERNS=(
		"FLAC__STREAM_DECODER_ERROR"
		"ERROR.*STREAMINFO"
		"ERROR.*metadata"
	)

	for PATTERN in "${ERROR_PATTERNS[@]}"; do
		if [ -n "$(ffmpeg -v error -i "$FILE" -f null - 2>&1)" ] && grep -q "$PATTERN" <<<"$FLAC_OUTPUT"; then
			echo "$1" >>"$TMP_LOG"
			return
		fi
	done
}

# Para asegurarnos que el archivo esta corrupto intentamos recodificarlo, si el
# archivo recodificado no tiene la misma duración que el original quiere decir
# que la codificación se interrumpió tempranamente y que el archivo esta corrupto.
#
# Con OVERWRITE=true el archivo recodificado sustituye al original si se
# trataba de un falso positivo
process_flac() {
	local FILE="$1"
	local RECODED_TRY="$RECODE_TMP_DIR/$(basename "$FILE")"
	local RECODED_FINAL="$RECODE_OUT_DIR/$(basename "$FILE")"

	if ! ffmpeg -y -i "$FILE" "$RECODED_TRY" >/dev/null 2>&1; then
		echo "$FILE" >>"$FINAL_LOG"
		return
	fi

	local OG_DURATION=$(ffprobe -i "$FILE" -show_entries format=duration -v quiet -of csv="p=0" | sed 's/\..*//')
	local RECODE_DURATION=$(ffprobe -i "$RECODED_TRY" -show_entries format=duration -v quiet -of csv="p=0" | sed 's/\..*//')

	if [ "$OG_DURATION" -ne "$RECODE_DURATION" ]; then
		echo "$FILE" >>"$FINAL_LOG"
	else
		if [ "$OVERWRITE" = "true" ]; then
			mv "$RECODED_TRY" "$FILE"
		else
			mv "$RECODED_TRY" "$RECODED_FINAL"
		fi
	fi
}

# Buscar archivos FLAC y comprobar si es posible que esten corruptos
find "$OG_DIR" -type f -name "*.flac" | while read -r FILE; do
	flac_check "$FILE" "$TMP_LOG"
done

# Comprobamos si hay algún falso positivo recodificando los archivos
while IFS= read -r FILE_PATH; do
	process_flac "$FILE_PATH"
done <"$TMP_LOG"

# Falsos positivos que fueron recodificados
grep -v -f "$FINAL_LOG" "$TMP_LOG" >"$RECODE_LOG"

rm -rf "$RECODE_TMP_DIR" "$TMP_LOG"

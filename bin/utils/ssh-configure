#!/bin/bash

# Script para instalar y configurar SSH en sistemas Arch Linux
# https://www.ssh-audit.com/hard ening_guide.html

# Salir si algún comando falla
set -e

if [ "$(id -u)" -ne 0 ]; then
	echo "Error: Este script debe ejecutarse como root." >&2
	exit 1
fi

install_ssh() {
	# Instalar OpenSSH y habilitar el servicio
	pacman -Sy --noconfirm openssh
	systemctl enable --now sshd
}

reinstall_ssh() {
	systemctl disable --now sshd
	rm -rf /etc/ssh
	sudo pacman -S --noconfirm openssh
	systemctl enable --now sshd
}

configure_ssh() {
	[ ! -e /etc/ssh/ssh_host_ed25519_key ] &&
		yes y | ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""

	[ ! -e /etc/ssh/ssh_host_rsa_key ] &&
		ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""

	cat <<-'EOF' | tee /etc/ssh/sshd_config.d/ssh-audit_hardening.conf
		KexAlgorithms sntrup761x25519-sha512@openssh.com
		Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com
		MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com
		HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com
	EOF

	sed -i 's|#PermitRootLogin prohibit-password|PermitRootLogin no|' /etc/ssh/sshd_config
	sed -i 's|#MaxAuthTries 6|MaxAuthTries 4|' /etc/ssh/sshd_config
	sed -i 's|#ClientAliveInterval 0|ClientAliveInterval 300|' /etc/ssh/sshd_config
}

configure_ufw() {
	# Instalar (si no lo está ya) y activar UFW
	if [ ! -x /usr/bin/ufw ]; then
		pacman -Sy --noconfirm ufw
		systemctl enable --now ufw
		ufw enable
	fi

	# Configurar UFW
	ufw allow 80/tcp
	ufw allow 443/tcp
	ufw allow 3020          # Redmine
	ufw allow in on virbr0  # Libvirt (NAT)
	ufw allow out on virbr0 # Libvirt (NAT)
	ufw limit ssh
	ufw default deny incoming
	ufw default allow outgoing
}

configure_fail2ban() {
	# Instalar (si no lo está ya) y activar fail2ban
	if [ ! -x /usr/bin/fail2ban-server ]; then
		pacman -Sy --noconfirm fail2ban
		systemctl enable --now fail2ban
	fi

	cat <<-'EOF' | tee /etc/fail2ban/action.d/ufw.conf
		[Definition]
		actionstart =
		actionstop =
		actioncheck =
		actionban = ufw insert 1 deny from <ip> to any
		actionunban = ufw delete deny from <ip> to any
	EOF

	# Activar el banneo para SSH
	cp /etc/fail2ban/fail2ban.conf /etc/fail2ban/jail.local

	cat <<-'EOF' | tee -a /etc/fail2ban/jail.local
		[sshd]
		backend = polling
		enabled = true
		port = ssh
		filter = sshd
		logpath = /var/log/auth.log
		maxretry = 2
		action = ufw
	EOF
}

install() {
	install_ssh
	configure_ssh
	configure_ufw
	configure_fail2ban
}

update() {
	reinstall_ssh
	configure_ssh
}

if [ "$1" = "-u" ]; then
	update
else
	install
fi

#!/bin/bash

FILE=$1
ROTATION=$2

FILENAME="${FILE%.*}"
EXTENSION="${FILE##*.}"

# Verificar que el archivo existe
[ ! -e "$FILE" ] && exit 1

# Detectar códec original
CODEC=$(
	ffprobe -v error -select_streams v:0 \
		-show_entries stream=codec_name \
		-of default=nokey=1:noprint_wrappers=1 "$FILE"
)

# Elegir filtro según rotación
case "$ROTATION" in
90) FILTER="transpose=1" ;;
180) FILTER="transpose=1,transpose=1" ;;
270) FILTER="transpose=2" ;;
*)
	echo "Rotación no válida (90, 180 o 270)"
	exit 1
	;;
esac

# Intentar copia directa (sin recodificar)
if ! ffmpeg -i "$FILE" -vf "$FILTER" -c:v copy -c:a copy -y "${FILENAME}_rotated.${EXTENSION}"; then
	if [[ "$CODEC" == "h264" ]]; then
		# H.264 → CRF
		ffmpeg -i "$FILE" -vf "$FILTER" -c:v libx264 -crf 18 -preset slow -c:a copy "${FILENAME}_rotated.${EXTENSION}"
	elif [[ "$CODEC" == "hevc" ]]; then
		# HEVC → CRF
		ffmpeg -i "$FILE" -vf "$FILTER" -c:v libx265 -crf 20 -preset slow -c:a copy "${FILENAME}_rotated.${EXTENSION}"
	else
		# Otros códecs
		ffmpeg -i "$FILE" -vf "$FILTER" -c:v "$CODEC" -qscale:v 2 -c:a copy "${FILENAME}_rotated.${EXTENSION}"
	fi
fi

#!/bin/bash
# shellcheck disable=SC2086

# Recodifíca videos a h.264 con la opción de rotarlos

IN_FILE=$1
MAX_RES="${MAX_RES:=1440}"
FILENAME="${IN_FILE%.*}"
RECODED_DIR="/tmp/recoded"
BASE_NAME="$(basename "$FILENAME")"
EXTENSION="${IN_FILE##*.}"
OUT_FILE=${2:=$RECODED_DIR/${BASE_NAME}_recoded.${EXTENSION}}
ROTATION=$3
TERM_OUTPUT=$(mktemp)

declare -A ERROR_MAP=(
	["No usable encoding entrypoint"]="VAAPI_UNSUPPORTED_PROFILE"
	["Function not implemented"]="VAAPI_NOT_IMPLEMENTED"
	["Could not open encoder"]="ENCODER_INIT_FAILED"
	["Invalid argument"]="INVALID_ARGUMENT"
)

detect_error() {
	local LOG="$1"
	local ERROR=false

	for pattern in "${!ERROR_MAP[@]}"; do
		if FILTER_ERR=$(grep "$pattern" <<<"$LOG"); then
			echo -e "${ERROR_MAP[$pattern]}"
			echo -e "\t$FILTER_ERR"
			ERROR=true
		fi
	done

	[ $ERROR == true ] && {
		rm -f "$OUT_FILE"
		exit 1
	}
}

[ ! -e "$IN_FILE" ] && exit 1
mkdir -p "$(dirname "$OUT_FILE")"

HEIGHT=$(
	ffprobe -v error -select_streams v:0 \
		-show_entries stream=height \
		-of default=nokey=1:noprint_wrappers=1 "$IN_FILE"
)

case "$ROTATION" in
90) ROTATE="transpose=1" ;;
180) ROTATE="transpose=1,transpose=1" ;;
270) ROTATE="transpose=2" ;;
*) ROTATE="" ;;
esac

FILTER=""
[ "$HEIGHT" -ge "$MAX_RES" ] && FILTER+="scale=-2:$MAX_RES"
[ -n "$ROTATE" ] && [ -n "$FILTER" ] && FILTER+=","
[ -n "$ROTATE" ] && FILTER+="$ROTATE"

HW_ACCEL="software"
if command -v nvidia-smi >/dev/null 2>&1; then
	HW_ACCEL="nvidia"
elif [ -d /dev/dri ]; then
	VAAPI_RENDER=$(ls /dev/dri/renderD* 2>/dev/null | head -n1)
	[ -n "$VAAPI_RENDER" ] && HW_ACCEL="vaapi"
fi

case "$HW_ACCEL" in
nvidia)
	VIDEO_CODEC="-c:v h264_nvenc -preset p5 -cq 23"
	VF="format=nv12"
	[ -n "$FILTER" ] && VF+=",$FILTER"
	;;
vaapi)
	VIDEO_CODEC="-c:v h264_vaapi -qp 23"
	VF="hwdownload,format=nv12"
	[ -n "$FILTER" ] && VF+=",$FILTER"
	VF="$FILTER"
	;;
software)
	VIDEO_CODEC="-c:v libx264 -preset medium -crf 23"
	VF="$FILTER"
	;;
esac

if [ "$HW_ACCEL" = "vaapi" ]; then
	ffmpeg -hide_banner -y \
		-init_hw_device vaapi="$VAAPI_RENDER" \
		-hwaccel vaapi -hwaccel_output_format vaapi \
		-i "$IN_FILE" \
		-vf "$VF" \
		$VIDEO_CODEC \
		-c:a copy \
		"$OUT_FILE" 2>"$TERM_OUTPUT"
else
	ffmpeg -hide_banner -y \
		-i "$IN_FILE" \
		-vf "$VF" \
		$VIDEO_CODEC \
		-c:a copy \
		"$OUT_FILE" 2>"$TERM_OUTPUT"
fi

detect_error "$(cat "$TERM_OUTPUT")"

echo "Archivo guardado en $OUT_FILE"

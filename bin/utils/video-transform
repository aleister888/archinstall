#!/bin/bash

# Recodifíca videos a h.264 con la opción de rotarlos

IN_FILE=$1

MAX_RES="${MAX_RES:=1440}"
FILENAME="${IN_FILE%.*}"

RECODED_DIR="/tmp/recoded"
BASE_NAME="$(basename "$FILENAME")"
EXTENSION="${IN_FILE##*.}"

OUT_FILE=${2:=$RECODED_DIR/${BASE_NAME}_recoded.${EXTENSION}}

ROTATION=$3

# Verificar que el archivo existe
[ ! -e "$IN_FILE" ] && exit 1

mkdir -p "$(dirname "$OUT_FILE")"

# Detectar altura del video
HEIGHT=$(
	ffprobe -v error -select_streams v:0 \
		-show_entries stream=height \
		-of default=nokey=1:noprint_wrappers=1 "$IN_FILE"
)

# Elegir filtro según rotación
case "$ROTATION" in
90) ROTATE="transpose=1" ;;
180) ROTATE="transpose=1,transpose=1" ;;
270) ROTATE="transpose=2" ;;
*) ROTATE="" ;;
esac

# Construir cadena de filtros
FILTER=""
[ "$HEIGHT" -ge "$MAX_RES" ] && FILTER+="scale=-2:$MAX_RES"
[ -n "$ROTATE" ] && [ -n "$FILTER" ] && FILTER+=","
[ -n "$ROTATE" ] && FILTER+="$ROTATE"

VAAPI_RENDER=$(/usr/bin/ls /dev/dri/renderD* 2>/dev/null | head -n1)
if [ -z "$VAAPI_RENDER" ]; then
	echo "No se encontró un dispositivo VAAPI."
	exit 1
fi

if ! {
	# Configuración para VAAPI
	VF="hwdownload,format=nv12"
	[ -n "$FILTER" ] && VF+=",$FILTER"
	VF+=",format=nv12,hwupload"

	ffmpeg -init_hw_device vaapi="$VAAPI_RENDER" \
		-hwaccel vaapi -hwaccel_output_format vaapi -i "$IN_FILE" \
		-vf "$VF" \
		-c:v hevc_vaapi \
		-c:a copy "$OUT_FILE"
}; then
	rm -f "$OUT_FILE"
	exit 1
fi

echo "Archivo guardado en $OUT_FILE"

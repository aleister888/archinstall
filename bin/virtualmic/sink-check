#!/bin/bash
# shellcheck disable=SC1091

# Script para comprobar que los sinks vinculados con el micrófono virtual
# no se han desvinculado. Muchas veces al pausar la aplicación que esta
# pasando audio, el sink de esta se desvincula con el micrófono virtual.

source "$HOME/.dotfiles/bin/virtualmic/env"

while true; do
	# Bloqueamos el proceso mientras se este eligiendo un sink
	while is_process_running virtualmic-select; do
		sleep 0.2
	done

	sink_list_build

	# Para cada sink supuestame añadido, comprobamos si está vinculado y existe
	while IFS= read -r SINK; do
		is_sink_linked "$SINK" && continue

		# Solo intentamos añadir si el sink existe actualmente
		pw-link -o | grep -Fq -- "$SINK" &&
			~/.dotfiles/bin/virtualmic/sink-link add "$SINK"
	done <"$ADDED_LIST"

	sleep 1
done

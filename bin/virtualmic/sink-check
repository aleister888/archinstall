#!/bin/bash
# shellcheck disable=SC1091

# Script para comprobar que los sinks vinculados con el micrófono virtual
# no se han desvinculado. Muchas veces al pausar la aplicación que esta
# pasando audio, el sink de esta se desvincula con el micrófono virtual.

source "$HOME/.dotfiles/bin/virtualmic/env"

while true; do
	# Bloqueamos el proceso mientras se este eligiendo un sink
	while pgrep --quiet -f virtualmic-select; do
		sleep 0.2
	done

	sink_list_build

	# Para cada dispositivo supuestamente añadido,
	# comprobamos que realmente lo está
	while IFS= read -r DEVICE; do
		# Si no lo está lo volvemos a vincular
		if ! grep -qF "$DEVICE" <<<"$DEL_DEVICES"; then
			~/.dotfiles/bin/virtualmic/sink-link add "$DEVICE"
		fi
	done <"$ADDED_LIST"

	sleep 0.2
done

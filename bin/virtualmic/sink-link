#!/bin/bash
# shellcheck disable=SC2086,SC1091

source "$HOME/.dotfiles/bin/virtualmic/env"

check_added() {
	if echo $DEL_DEVICES | grep -q "$SINK"; then
		notify "$ICON" "$NOTIFICATION_TITLE" "Sink vinculado correctamente"
	else
		notify "$ICON" "$NOTIFICATION_TITLE" "Fallo al añadir el sink"
	fi
}

check_deleted() {
	if ! echo $DEL_DEVICES | grep -q "$SINK"; then
		notify "$ICON" "$NOTIFICATION_TITLE" "Sink desvinculado correctamente"
	else
		notify "$ICON" "$NOTIFICATION_TITLE" "Fallo al desvincular el sink"
	fi
}

# Vincular/desvincular un sink del micrófono virtual
sink_link() {
	[ "$1" = "del" ] && FLAG="-d"
	SINK="$2"

	local SINK_L="my-combined-sink:playback_FL"
	local SINK_R="my-combined-sink:playback_FR"

	# Formateamos en función de si el sink está separado en FL/FR, 1/2 o es mono
	case "$SINK" in
	*FL) CSINK="${SINK%FL}FR" ;;
	*FR) CSINK="$SINK" SINK="${SINK%FR}FL" ;;
	*1) CSINK="${SINK%1}2" ;;
	*2) CSINK="$SINK" SINK="${SINK%2}1" ;;
	*) CSINK="$SINK" ;;
	esac

	timeout -k 1s 1s pw-link $FLAG "$SINK" "$SINK_L"
	timeout -k 1s 1s pw-link $FLAG "$CSINK" "$SINK_R"

	[ "$1" = "del" ] && {
		# Borramos el sink de la lista de sinks añadidos
		grep -v "$SELECTED" $ADDED_LIST >$ADDED_LIST.tmp
		mv $ADDED_LIST.tmp $ADDED_LIST
	}

	sink_list_build

	if [ "$1" = "add" ]; then
		check_added
		echo $SINK >>$ADDED_LIST
	elif [ "$1" = "del" ]; then
		check_deleted
	fi
}

sink_link "$@"

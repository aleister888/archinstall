#!/bin/bash
# shellcheck disable=SC2086,SC1091

source "$HOME/.dotfiles/bin/virtualmic/env"

notify_added() {
	[[ "$(get_parent_process)" == *"sink-check"* ]] && return 0
	if is_sink_linked "$SINK"; then
		notify "$ICON" "$NOTIFICATION_TITLE" "Sink vinculado correctamente"
	else
		notify "$ICON" "$NOTIFICATION_TITLE" "Fallo al a침adir el sink"
	fi
}

notify_deleted() {
	if ! is_sink_linked "$SINK"; then
		notify "$ICON" "$NOTIFICATION_TITLE" "Sink desvinculado correctamente"
	else
		notify "$ICON" "$NOTIFICATION_TITLE" "Fallo al desvincular el sink"
	fi
}

# Vincular/desvincular un sink del micr칩fono virtual
sink_link() {
	[ "$1" = "del" ] && FLAG="-d"
	SINK="$2"

	local SINK_L="my-combined-sink:playback_FL"
	local SINK_R="my-combined-sink:playback_FR"

	# Formateamos en funci칩n de si el sink est치 separado en FL/FR, 1/2 o es mono
	case "$SINK" in
	*FL) CSINK="${SINK%FL}FR" ;;
	*FR) CSINK="$SINK" SINK="${SINK%FR}FL" ;;
	*1) CSINK="${SINK%1}2" ;;
	*2) CSINK="$SINK" SINK="${SINK%2}1" ;;
	*) CSINK="$SINK" ;;
	esac

	timeout -k 1s 1s pw-link $FLAG "$SINK" "$SINK_L" || return 1
	timeout -k 1s 1s pw-link $FLAG "$CSINK" "$SINK_R" || return 1

	# Notificamos y actualizamos la lista
	case "$1" in
	"add")
		notify_added
		grep -Fxq "$SINK" "$ADDED_LIST" || echo "$SINK" >>"$ADDED_LIST"
		;;
	"del")
		notify_deleted
		delete_sink_from_list "$SINK"
		;;
	esac
}

sink_link "$@"

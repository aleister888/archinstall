#!/bin/bash
# shellcheck disable=SC2086,SC2181,SC1091,SC2001

# Vincular (dispositivos de entrada)|(aplicaciones) a un micrófono virtual para compartir audio

source "$HOME/.dotfiles/bin/virtualmic/env"

DMENU="rofi -dmenu"
DMENU_LINES="-l"

sink_links_edit() {
	local DMENU_SELECTED SINKS_LIST FORMATED_SINKS_LIST

	case "$1" in
	"add") SINKS_LIST=$DEVICES ;;
	*) SINKS_LIST=$DEL_DEVICES ;;
	esac

	FORMATED_SINKS_LIST=$(sed 's/:[^:]*$//' <<<"$SINKS_LIST" | sort -u)

	DMENU_SELECTED=$(echo "$FORMATED_SINKS_LIST" | $DMENU $DMENU_LINES "$(echo "$FORMATED_SINKS_LIST" | wc -l)")
	[ -z "$DMENU_SELECTED" ] && exit

	SELECTED=$(grep "$DMENU_SELECTED" <<<"$SINKS_LIST" | sed '1q;d')
	[ -z "$SELECTED" ] && exit

	"$HOME"/.dotfiles/bin/virtualmic/sink-link "$1" "$SELECTED"
}

# shellcheck disable=SC2155
set_max_samplerate() {
	local DEFAULT_SINK AUDIO_ID MAX_RATE

	samplerate_error() {
		notify system-error "$NOTIFICATION_TITLE" "Error al establecer el samplerate"
		exit 1
	}

	DEFAULT_SINK=$(pactl info | awk -F': ' '/Default Sink/ {print $2}')

	AUDIO_ID=$(pw-dump | jq -r ".[] | select(.type==\"PipeWire:Interface:Node\" and .info.props[\"node.name\"]==\"$DEFAULT_SINK\") | .id")
	[ -z "$AUDIO_ID" ] && samplerate_error

	MAX_RATE=$(pw-dump | jq ".[] | select(.id == $AUDIO_ID) | .info.params.EnumFormat[0].rate.max")
	[ -z "$MAX_RATE" ] && MAX_RATE=$(pw-dump | jq ".[] | select(.id == $AUDIO_ID) | .info.params.EnumFormat[0].rate")
	[ -z "$MAX_RATE" ] || [ "$MAX_RATE" = "null" ] && samplerate_error

	pw-metadata -n settings 0 clock.force-rate "$MAX_RATE" &&
		notify audio-card "$NOTIFICATION_TITLE" "Samplerate establecido a $MAX_RATE"
}

#-------------------------------------------------------------------------------

# Nos aseguramos que el micrófono virtual existe
{ pactl list | grep -q my-virtualmic; } || exit 1

# Nos aeguramos que el sink combinado y el micrófono virtual estén conectados
pw-link my-combined-sink:monitor_FL my-virtualmic:input_FL 2>/dev/null
pw-link my-combined-sink:monitor_FR my-virtualmic:input_FR 2>/dev/null

ADD_MSG="Añadir sink al micrófono virtual"
DEL_MSG="Quitar sink del micrófono virtual"
RATE_MSG="Establecer el samplerate"

CHOSEN=$(echo -e "$ADD_MSG\n$DEL_MSG\n$RATE_MSG" | eval $DMENU $DMENU_LINES 3)
[ -z "$CHOSEN" ] && exit 1

sink_list_build

case "$CHOSEN" in
"$ADD_MSG")
	[ -z "$DEVICES" ] && {
		notify "$ICON" "$NOTIFICATION_TITLE" "No hay sinks que añadir"
		exit
	}
	sink_links_edit add
	;;
"$DEL_MSG")
	[ -z "$DEL_DEVICES" ] && {
		notify "$ICON" "$NOTIFICATION_TITLE" "No hay sinks que borrar"
		exit
	}
	sink_links_edit del
	;;
"$RATE_MSG") set_max_samplerate ;;
esac

#!/bin/sh

# Script para crear un micrófono virtual que cogera el
# sonido de nuestro micrófono real y de las aplicaciones
# cuyo audio queremos compartir.

mic_setup() {
	# Comprobamos que no existe el micrófono virtual
	if ! pactl list | grep -q my-combined-sink; then
		# Creamos un sink virtual
		pactl load-module module-null-sink \
			media.class=Audio/Sink sink_name=my-combined-sink \
			channel_map=stereo

		# Creamos un micrófono virtual
		pactl load-module module-null-sink \
			media.class=Audio/Source/Virtual sink_name=my-virtualmic \
			channel_map=front-left,front-right

		# Asociamos nuestro sink virtual a nuestro micrófono virtual
		pw-link my-combined-sink:monitor_FL my-virtualmic:input_FL
		pw-link my-combined-sink:monitor_FR my-virtualmic:input_FR

		pactl set-sink-volume my-combined-sink 100%

		# Reiniciamos la lista con los sinks vinculados
		install /dev/null "$ADDED_LIST"
	fi

	# Más tarde asociaremos el audio de las aplicaciones/dispositivos a nuestro
	# sink virtual con virtualmic-select
}

sleep 1

COUNTER=0

while [ $COUNTER -lt 20 ]; do
	pgrep wireplumber && mic_setup && exit 1
	COUNTER=$((COUNTER + 1))
	sleep 1
done
